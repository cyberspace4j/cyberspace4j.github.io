---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
    function slugify(text: string) {
        return text
            .toString()
            .toLowerCase()
            .replace(/\s+/g, '-')     
            .replace(/[^\w\-]+/g, '') 
            .replace(/\-\-+/g, '-')   
            .replace(/^-+/, '')       
            .replace(/-+$/, '');      
    }

    const allPosts = await getCollection('blog');
    const uniqueCategories = [...new Set(allPosts.map((post) => post.data.categories || []).flat())].filter(Boolean) as string[];

    return uniqueCategories.map((category) => {
        const filteredPosts = allPosts.filter((post) => 
            post.data.categories && post.data.categories.includes(category)
        );
        
        filteredPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

        return {
            params: { category: slugify(category) },
            props: { 
                categoryName: category,
                posts: filteredPosts 
            },
        };
    });
}

const { categoryName, posts } = Astro.props; 
const displayTitle = categoryName || Astro.params.category;

const getTagClass = (tag: string) => {
    const slug = tag.toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '');
    return `tag-${slug}`;
};
---

<!doctype html>
<html lang="es">
    <head>
        <BaseHead title={`${displayTitle} - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
        <style>
            main {
                width: 100%;
                max-width: 1200px;
                margin: 0 auto;
                padding: 1em;
            }
            .category-header {
                border-bottom: 2px solid var(--accent);
                padding-bottom: 10px;
                margin-bottom: 40px;
                display: flex;
                align-items: center;
                gap: 1rem;
            }
            .category-header h1 {
                text-transform: capitalize;
                font-size: 2.5em;
                margin: 0;
            }
            .count {
                font-size: 0.4em;
                background: var(--accent);
                color: #fff;
                padding: 4px 10px;
                border-radius: 99px;
                vertical-align: middle;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <Header />
        <main>
            <div class="category-header">
                <h1> {displayTitle} <span class="count">{posts.length}</span></h1>
            </div>
            
            <section>
                <ul class="clean-grid">
                    {
                        posts.map((post) => (
                            <li>
                                <a href={`/blog/${post.id}/`} class="clean-card">
                                    
                                    {/* 1. TAGS (AHORA ARRIBA DEL TODO) */}
                                    {post.data.tags && (
                                        <div class="tag-container">
                                            {post.data.tags.map((tag: string) => (
                                                <span class={`tag-pill ${getTagClass(tag)}`}>
                                                    {tag}
                                                </span>
                                            ))}
                                        </div>
                                    )}

                                    {/* 2. TÍTULO */}
                                    <h3>{post.data.title}</h3>

                                    {/* 3. DESCRIPCIÓN */}
                                    <p class="description">
                                        {post.data.description || "Sin descripción disponible."}
                                    </p>
                                    
                                    {/* 4. FECHA (AHORA ABAJO DEL TODO) */}
                                    <span class="date">
                                        Actualizado el {post.data.pubDate.toLocaleDateString('es-ES', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric',
                                        })}
                                    </span>

                                </a>
                            </li>
                        ))
                    }
                </ul>
            </section>
        </main>
        <Footer />
    </body>
</html>